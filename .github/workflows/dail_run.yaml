name: Daily Telegram Push

permissions:
  contents: read

on:
  schedule:
    - cron: "0 19 * * *" # 19:00 UTC = 21:00 CEST (summer time)
    - cron: "0 20 * * *" # 20:00 UTC = 21:00 CET  (winter time)
  workflow_dispatch:

concurrency:
  group: daily-telegram-push
  cancel-in-progress: false

jobs:
  run:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Sync Python deps (uv.lock)
        run: |
          uv sync --frozen

      - name: Gate by Europe/Amsterdam 21:00 (hour window)
        run: |
          uv run python - <<'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo

          now = datetime.now(ZoneInfo("Europe/Amsterdam"))

          # Allow any minute within 21:00â€“21:59 local time
          if now.hour != 21:
              print(f"Skip: local time is {now.isoformat(timespec='seconds')}")
              raise SystemExit(0)

          print(f"Proceed: local time is {now.isoformat(timespec='seconds')}")
          PY

      - name: Install Playwright Chromium
        run: |
          uv run playwright install --with-deps chromium

      - name: Run push pipeline
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          uv run python -m push_notification.main
